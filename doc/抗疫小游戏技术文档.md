# 抗疫小游戏技术文档



## 1 数据库

### 1.1 用户表(userinfo)

| 字段           | 类型与长度 | 是否必填 | 备注                                    |
| -------------- | ---------- | -------- | --------------------------------------- |
| id             | int        | 是       | 主键，自增                              |
| openid         |            | 是       |                                         |
| createtime     |            | 是       | 创建时间，格式YYYY-MM-DD HH:MM:SS，下同 |
| lastupdatetime |            |          |                                         |
| sessionkey     |            | 是       |                                         |
| token          |            | 是       | 根据openid和sessionkey和id计算得出      |

* token的计算方式待定



### 1.2 故事表(storyinfo)

| 字段      | 类型与长度 | 是否必填 | 备注                           |
| --------- | ---------- | -------- | ------------------------------ |
| id        |            | 是       | 主键，自增                     |
| openid    |            | 是       |                                |
| round     |            | 是       | 游戏在第几回合                 |
| day       |            | 是       | 游戏在第几天                   |
| starttime |            | 是       | 开始时间                       |
| endtime   |            |          | 如结束，结束时间，否则为空     |
| status    |            | 是       | 0-进行中，1-已结束，2-一场结束 |



### 1.3 卡表（cardinfo,待补充）

| 字段 | 类型与长度 | 是否必填 | 备注       |
| ---- | ---------- | -------- | ---------- |
| id   |            | 是       | 主键，自增 |
|      |            |          |            |
|      |            |          |            |



### 1.4 选择卡的数据表(choseninfo)

| 字段     | 类型与长度 | 是否必填 | 备注       |
| -------- | ---------- | -------- | ---------- |
| id       |            | 是       | 主键，自增 |
| openid   |            |          |            |
| storyid  |            |          |            |
| cardid   |            |          |            |
| choice   |            |          |            |
| timecost |            |          |            |



### 1.5 错误信息上报表(errcontent)

| 字段    | 类型与长度 | 是否必填 | 备注       |
| ------- | ---------- | -------- | ---------- |
| id      |            | 是       | 主键，自增 |
| openid  |            |          |            |
| storyid |            |          |            |
| cardid  |            |          |            |



## 2 接口文档

### 2.1 基础接口

#### 2.1.1 登录

##### 接口名

/login

##### 请求

| 字段名 | 类型 | 是否必填 | 描述 |
| ------ | ---- | -------- | ---- |
| code   |      |          |      |
|        |      |          |      |
|        |      |          |      |

##### 接口逻辑

* [微信开发文档-登录流程](https://developers.weixin.qq.com/minigame/dev/guide/open-ability/login.html)
* 拿着code和appid、appsecret去请求sessionkey和openid
* 判断openid是否存在，存在则走更新流程，否则走注册流程
* 利用id、openid、sessionkey计算出token并返回



##### 返回

成功

{

errcode:0

token:

}

失败

{errcode:错误码

content:错误信息

}



#### 2.1.2 数据上报

##### 接口名

/tracer

##### 请求

| 字段名   | 类型 | 是否必填 | 描述 |
| -------- | ---- | -------- | ---- |
| openid   |      | 是       |      |
| parament |      | 是       |      |
| parament |      | 是       |      |
| tracerid |      | 是       |      |

##### 接口逻辑

* tracerid=1时，上报选择信息到choosecard表
* parament的格式为json串
* 拿到parament串后，直接解析保存到choosencard表



##### 返回

写入到表成功时

{errcode:0}

写入失败

{errcode:

content:相关错误信息}



### 2.2 游戏相关

#### 2.2.1 初始化

##### 接口名

/initgame

##### 请求

| 字段名 | 类型 | 是否必填 | 描述 |
| ------ | ---- | -------- | ---- |
| openid |      | 是       |      |

##### 接口逻辑

* 参考初始化流程图



##### 返回

{

errcode:0

content:{

storyid:

firstday:YYYY-MM-DD

}

}



#### 2.2.2 获取下一张卡片（待完善）

##### 接口名

/getnextcard

##### 请求

| 字段名        | 类型 | 是否必填 | 描述                                       |
| ------------- | ---- | -------- | ------------------------------------------ |
| openid        |      | 是       |                                            |
| storyid       |      | 是       |                                            |
| handcardlist  |      |          | 当前卡id                                   |
| curcardoption |      |          | 当前卡的选项                               |
| cardinhand    |      |          | 当前手中的卡片id列表（不包含当前处理的卡） |
| mainpara      |      |          | 主变量列表                                 |
| assistpara    |      |          | 暗变量列表                                 |
| day           |      |          | 当前进行到的天数（                         |
|               |      |          |                                            |
|               |      |          |                                            |

##### 接口逻辑

* 参考获取卡片流程图



##### 返回

卡片基本信息





